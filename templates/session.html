{{define "session-content"}}
<div id="session-content">
    <div class="grid lg:grid-cols-4 gap-6">
        <!-- Participants Sidebar -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="material-icons text-blue-600 mr-2">group</span>
                    Participants ({{len .Session.Participants}})
                </h3>
                <div id="participants-list" class="space-y-2">
                    {{range .Session.Participants}}
                    <div class="participant flex items-center justify-between p-2 bg-gray-50 rounded" data-user-id="{{.ID}}">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                                <span class="text-blue-600 font-medium text-sm">{{slice .Username 0 1}}</span>
                            </div>
                            <span class="text-sm font-medium">{{.Username}}</span>
                            {{if eq .ID $.Session.OwnerID}}
                            <span class="ml-1 px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded-full">Owner</span>
                            {{end}}
                        </div>
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-green-400 rounded-full" title="Online"></div>
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Ticket Queue -->
            {{if .Session.Tickets}}
            <div class="bg-white rounded-lg shadow-md p-4 mt-4">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="material-icons text-green-600 mr-2">list_alt</span>
                    Tickets ({{len .Session.Tickets}})
                </h3>
                <div id="tickets-list" class="space-y-2">
                    {{range $index, $ticket := .Session.Tickets}}
                    {{if eq $.User.ID $.Session.OwnerID}}
                    <div class="ticket-item p-2 rounded border cursor-pointer hover:bg-gray-50 transition-colors {{if and $.Session.CurrentTicket (eq $ticket.ID $.Session.CurrentTicket.ID)}}border-blue-500 bg-blue-50{{else}}border-gray-200{{end}}" 
                         onclick="selectTicket({{$ticket.ID}})"
                         title="Click to select this ticket">
                        <div class="text-sm font-medium">{{$ticket.Title}}</div>
                        {{if $ticket.FinalEstimate}}
                        <div class="text-xs text-green-600 font-medium">Estimated: {{$ticket.FinalEstimate}}</div>
                        {{end}}
                        {{$ticketAvg := index $.TicketAverages $ticket.ID}}
                        {{$isCurrentTicket := and $.Session.CurrentTicket (eq $ticket.ID $.Session.CurrentTicket.ID)}}
                        {{$hideAverage := and $.Session.IsVotingActive $isCurrentTicket}}
                        {{if and $ticketAvg (not $hideAverage)}}
                        <div class="text-xs text-purple-600 font-medium">Avg: {{printf "%.1f" $ticketAvg}}</div>
                        {{end}}
                        {{if and $.Session.CurrentTicket (eq $ticket.ID $.Session.CurrentTicket.ID)}}
                        <div class="text-xs text-blue-600 font-medium">Current ticket</div>
                        {{end}}
                    </div>
                    {{else}}
                    <div class="ticket-item p-2 rounded border {{if and $.Session.CurrentTicket (eq $ticket.ID $.Session.CurrentTicket.ID)}}border-blue-500 bg-blue-50{{else}}border-gray-200{{end}}">
                        <div class="text-sm font-medium">{{$ticket.Title}}</div>
                        {{if $ticket.FinalEstimate}}
                        <div class="text-xs text-green-600 font-medium">Estimated: {{$ticket.FinalEstimate}}</div>
                        {{end}}
                        {{$ticketAvg := index $.TicketAverages $ticket.ID}}
                        {{$isCurrentTicket := and $.Session.CurrentTicket (eq $ticket.ID $.Session.CurrentTicket.ID)}}
                        {{$hideAverage := and $.Session.IsVotingActive $isCurrentTicket}}
                        {{if and $ticketAvg (not $hideAverage)}}
                        <div class="text-xs text-purple-600 font-medium">Avg: {{printf "%.1f" $ticketAvg}}</div>
                        {{end}}
                        {{if and $.Session.CurrentTicket (eq $ticket.ID $.Session.CurrentTicket.ID)}}
                        <div class="text-xs text-blue-600 font-medium">Current ticket</div>
                        {{end}}
                    </div>
                    {{end}}
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>

        <!-- Main Content Area -->
        <div class="lg:col-span-3">
            <!-- Current Ticket Display -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                {{if .Session.CurrentTicket}}
                <div class="text-center">
                    <div class="mb-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                            Ticket {{.CurrentTicketIndex}} of {{len .Session.Tickets}}
                        </span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">{{.Session.CurrentTicket.Title}}</h2>
                    {{if .Session.CurrentTicket.Description}}
                    <p class="text-gray-600 mb-6">{{.Session.CurrentTicket.Description}}</p>
                    {{end}}
                    
                    {{if .Session.IsVotingActive}}
                    <div class="mb-4">
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            <span class="material-icons text-sm mr-1">how_to_vote</span>
                            Voting in Progress
                        </span>
                    </div>
                    {{end}}
                </div>
                {{else}}
                <div class="text-center py-12">
                    <span class="material-icons text-gray-400 text-6xl mb-4">assignment</span>
                    <h2 class="text-xl font-semibold text-gray-600 mb-2">No Ticket Selected</h2>
                    <p class="text-gray-500">Add tickets to start planning</p>
                </div>
                {{end}}
            </div>

            <!-- Voting Cards -->
            {{if .Session.CurrentTicket}}
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4 text-center">
                    Select Your Estimate
                    {{if not .Session.IsVotingActive}}
                    <span class="text-sm font-normal text-gray-600">(Voting not started)</span>
                    {{end}}
                </h3>
                <div id="voting-cards" class="grid grid-cols-4 md:grid-cols-7 lg:grid-cols-14 gap-3">
                    {{range .VotingCards}}
                    <button 
                        class="card voting-card bg-white border-2 rounded-lg p-4 text-center hover:border-blue-500 focus:outline-none focus:border-blue-500 {{if and $.UserVote (eq . $.UserVote.VoteValue)}}border-blue-500 bg-blue-50 selected{{else}}border-gray-300{{end}}"
                        data-value="{{.}}"
                        onclick="castVote('{{.}}')"
                    >
                        <span class="text-lg font-bold">{{.}}</span>
                    </button>
                    {{end}}
                </div>
                <div id="vote-status" class="mt-4 text-center">
                    {{if .UserVote}}
                    <div class="text-green-600 font-medium">
                        <span class="material-icons text-sm mr-1">check_circle</span>
                        Your vote: {{.UserVote.VoteValue}}
                        {{if not .Session.IsVotingActive}}
                        <span class="text-gray-500 text-sm"> â€¢ Click any card to change your vote</span>
                        {{end}}
                    </div>
                    {{else if .Session.IsVotingActive}}
                    <div class="text-gray-500">
                        <span class="material-icons text-sm mr-1">radio_button_unchecked</span>
                        Select a card to vote
                    </div>
                    {{else}}
                    <div class="text-gray-500">
                        <span class="material-icons text-sm mr-1">assignment</span>
                        Click any card to cast your vote
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Voting Status Panel -->
            {{if .Session.CurrentTicket}}
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Participant Votes</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {{range .Session.Participants}}
                    {{$participant := .}}
                    {{$userVote := ""}}
                    {{$hasVoted := false}}
                    {{if $.Session.CurrentTicket.Votes}}
                    {{range $.Session.CurrentTicket.Votes}}
                        {{if eq .UserID $participant.ID}}
                            {{$userVote = .VoteValue}}
                            {{$hasVoted = true}}
                        {{end}}
                    {{end}}
                    {{end}}
                    <div class="participant-card flex flex-col items-center p-3 bg-gray-50 rounded-lg relative cursor-pointer hover:bg-gray-100 transition-colors" 
                         data-participant-id="{{$participant.ID}}" 
                         data-participant-name="{{$participant.Username}}"
                         onmouseenter="showEmojiPicker(this, event)" 
                         onmouseleave="hideEmojiPicker()">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mb-2">
                            <span class="text-blue-600 font-medium text-sm">{{slice .Username 0 1}}</span>
                        </div>
                        <span class="text-sm font-medium mb-2">{{.Username}}</span>
                        {{if $.Session.IsVotingActive}}
                            {{if $hasVoted}}
                            <div class="w-12 h-16 bg-blue-600 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-white">check</span>
                            </div>
                            {{else}}
                            <div class="w-12 h-16 bg-gray-300 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-gray-500">timer</span>
                            </div>
                            {{end}}
                        {{else}}
                            {{if $hasVoted}}
                            <div class="w-12 h-16 bg-green-100 border-2 border-green-300 rounded-lg flex items-center justify-center">
                                <span class="text-green-700 font-bold">{{$userVote}}</span>
                            </div>
                            {{else}}
                            <div class="w-12 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                                <span class="text-gray-500 text-xs">No vote</span>
                            </div>
                            {{end}}
                        {{end}}
                    </div>
                    {{end}}
                </div>
            </div>
            {{end}}
            {{end}}

            <!-- Results Panel -->
            {{if and .Session.CurrentTicket (not .Session.IsVotingActive)}}
            <div id="results-panel" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Voting Results</h3>
                {{if .Session.CurrentTicket.Votes}}
                <div class="space-y-2 mb-4">
                    {{range .VoteHistogram}}
                    <div class="flex items-center">
                        <div class="w-8 text-center font-medium">{{.Value}}</div>
                        <div class="flex-1 mx-3">
                            <div class="bg-gray-200 rounded-full h-6 relative">
                                <div class="bg-blue-500 h-6 rounded-full flex items-center justify-end pr-2" style="width: {{.Percentage}}%">
                                    {{if gt .Count 0}}
                                    <span class="text-white text-xs font-medium">{{.Count}}</span>
                                    {{end}}
                                </div>
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>
                
                <div class="text-sm text-gray-600 mb-4">
                    Individual votes:
                    {{range .Session.CurrentTicket.Votes}}
                    <span class="inline-block bg-gray-100 rounded px-2 py-1 mr-1 mb-1">
                        {{if .User}}{{.User.Username}}{{end}}: {{.VoteValue}}
                    </span>
                    {{end}}
                </div>
                {{else}}
                <p class="text-gray-500">No votes cast yet.</p>
                {{end}}
            </div>
            {{end}}

            <!-- Owner Controls -->
            {{if eq .User.ID .Session.OwnerID}}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="material-icons text-purple-600 mr-2">admin_panel_settings</span>
                    Session Controls
                </h3>
                
                <div class="flex flex-wrap gap-3">
                    <!-- Add Ticket -->
                    <button 
                        class="btn bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                        onclick="showAddTicketModal()"
                    >
                        <span class="material-icons text-sm mr-1">add</span>
                        Add Ticket
                    </button>

                    {{if .Session.CurrentTicket}}
                    <!-- Voting Controls -->
                    {{if .Session.IsVotingActive}}
                    <button 
                        class="btn bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
                        onclick="endVoting()"
                    >
                        <span class="material-icons text-sm mr-1">stop</span>
                        End Voting
                    </button>
                    {{else}}
                    <button 
                        class="btn bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                        onclick="startVoting()"
                    >
                        <span class="material-icons text-sm mr-1">play_arrow</span>
                        Start Voting
                    </button>
                    {{end}}

                    <!-- Next Ticket (only show if there's a next ticket) -->
                    {{if and .Session.CurrentTicket (lt .CurrentTicketIndex (len .Session.Tickets))}}
                    <button 
                        class="btn bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
                        onclick="nextTicket()"
                    >
                        <span class="material-icons text-sm mr-1">skip_next</span>
                        Next Ticket
                    </button>
                    {{end}}

                    <!-- Review Session -->
                    <button 
                        class="btn bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700"
                        onclick="showReviewModal()"
                    >
                        <span class="material-icons text-sm mr-1">summarize</span>
                        Review
                    </button>
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>
    </div>
</div>

<script>
// Define session ID for JavaScript usage (avoid redeclaration)
window.sessionId = window.sessionId || {{.Session.ID}};

function showAddTicketModal() {
    const modal = document.getElementById('add-ticket-modal');
    
    if (modal) {
        modal.classList.remove('hidden');
        
        // Clear form inputs
        const titleInput = document.getElementById('ticket-title');
        const descriptionInput = document.getElementById('ticket-description');
        
        if (titleInput) {
            titleInput.value = '';
            titleInput.focus();
        }
        if (descriptionInput) {
            descriptionInput.value = '';
        }
        
        // Clear any validation errors
        clearValidationErrors();
    }
}

function hideAddTicketModal() {
    const modal = document.getElementById('add-ticket-modal');
    const titleInput = document.getElementById('ticket-title');
    const descriptionInput = document.getElementById('ticket-description');
    
    if (modal) modal.classList.add('hidden');
    if (titleInput) titleInput.value = '';
    if (descriptionInput) descriptionInput.value = '';
    // Clear any validation errors
    clearValidationErrors();
}

function clearValidationErrors() {
    const titleInput = document.getElementById('ticket-title');
    if (titleInput) {
        titleInput.classList.remove('border-red-500');
    }
    const existingError = document.getElementById('title-error');
    if (existingError) {
        existingError.remove();
    }
}

function validateTicketForm() {
    const titleInput = document.getElementById('ticket-title');
    
    // Check if elements exist (might be removed by WebSocket update)
    if (!titleInput) {
        console.log('Ticket form elements not found, validation skipped');
        return false;
    }
    
    const title = titleInput.value ? titleInput.value.trim() : '';
    
    // Clear previous validation
    clearValidationErrors();
    
    if (!title) {
        // Show validation error
        titleInput.classList.add('border-red-500');
        const errorDiv = document.createElement('div');
        errorDiv.id = 'title-error';
        errorDiv.className = 'text-red-500 text-sm mt-1';
        errorDiv.textContent = 'Title is required';
        if (titleInput.parentNode) {
            titleInput.parentNode.appendChild(errorDiv);
        }
        titleInput.focus();
        return false;
    }
    
    if (title.length > 200) {
        titleInput.classList.add('border-red-500');
        const errorDiv = document.createElement('div');
        errorDiv.id = 'title-error';
        errorDiv.className = 'text-red-500 text-sm mt-1';
        errorDiv.textContent = 'Title must be no more than 200 characters';
        if (titleInput.parentNode) {
            titleInput.parentNode.appendChild(errorDiv);
        }
        titleInput.focus();
        return false;
    }
    
    return true;
}

function handleFormError(errorMessage) {
    // Show server validation error
    const titleInput = document.getElementById('ticket-title');
    if (titleInput) {
        titleInput.classList.add('border-red-500');
        const errorDiv = document.createElement('div');
        errorDiv.id = 'title-error';
        errorDiv.className = 'text-red-500 text-sm mt-1';
        errorDiv.textContent = errorMessage || 'An error occurred while creating the ticket';
        if (titleInput.parentNode) {
            titleInput.parentNode.appendChild(errorDiv);
        }
    }
}

function showEndSessionModal() {
    const modal = document.getElementById('end-session-modal');
    if (modal) modal.classList.remove('hidden');
}

function hideEndSessionModal() {
    const modal = document.getElementById('end-session-modal');
    if (modal) modal.classList.add('hidden');
}

function showLeaveSessionModal() {
    const modal = document.getElementById('leave-session-modal');
    if (modal) modal.classList.remove('hidden');
}

function hideLeaveSessionModal() {
    const modal = document.getElementById('leave-session-modal');
    if (modal) modal.classList.add('hidden');
}

function showEditUsernameModal() {
    const modal = document.getElementById('edit-username-modal');
    const usernameInput = document.getElementById('new-username');
    
    if (modal) modal.classList.remove('hidden');
    if (usernameInput) usernameInput.select();
}

function hideEditUsernameModal() {
    const modal = document.getElementById('edit-username-modal');
    if (modal) modal.classList.add('hidden');
    // Clear any validation errors
    clearUsernameValidationErrors();
}

function clearUsernameValidationErrors() {
    const usernameInput = document.getElementById('new-username');
    if (usernameInput) {
        usernameInput.classList.remove('border-red-500');
    }
    const existingError = document.getElementById('username-error');
    if (existingError) {
        existingError.remove();
    }
}

function validateUsernameForm() {
    const usernameInput = document.getElementById('new-username');
    
    // Check if elements exist (might be removed by WebSocket update)
    if (!usernameInput) {
        console.log('Username form elements not found, validation skipped');
        return false;
    }
    
    const username = usernameInput.value ? usernameInput.value.trim() : '';
    
    // Clear previous validation
    clearUsernameValidationErrors();
    
    if (!username) {
        // Show validation error
        usernameInput.classList.add('border-red-500');
        const errorDiv = document.createElement('div');
        errorDiv.id = 'username-error';
        errorDiv.className = 'text-red-500 text-sm mt-1';
        errorDiv.textContent = 'Username is required';
        if (usernameInput.parentNode) {
            usernameInput.parentNode.appendChild(errorDiv);
        }
        usernameInput.focus();
        return false;
    }
    
    if (username.length > 50) {
        usernameInput.classList.add('border-red-500');
        const errorDiv = document.createElement('div');
        errorDiv.id = 'username-error';
        errorDiv.className = 'text-red-500 text-sm mt-1';
        errorDiv.textContent = 'Username must be no more than 50 characters';
        if (usernameInput.parentNode) {
            usernameInput.parentNode.appendChild(errorDiv);
        }
        usernameInput.focus();
        return false;
    }
    
    // Basic character validation
    if (!/^[a-zA-Z0-9\s\-_]+$/.test(username)) {
        usernameInput.classList.add('border-red-500');
        const errorDiv = document.createElement('div');
        errorDiv.id = 'username-error';
        errorDiv.className = 'text-red-500 text-sm mt-1';
        errorDiv.textContent = 'Username can only contain letters, numbers, spaces, hyphens, and underscores';
        if (usernameInput.parentNode) {
            usernameInput.parentNode.appendChild(errorDiv);
        }
        usernameInput.focus();
        return false;
    }
    
    return true;
}

function selectTicket(ticketId) {
    fetch('/session/' + window.sessionId + '/select-ticket/' + ticketId, {
        method: 'POST'
    }).then(response => {
        if (response.ok) {
            // Refresh only after successful selection
            window.location.reload();
        }
    });
}

function startVoting() {
    fetch('/session/' + window.sessionId + '/start-voting', {
        method: 'POST'
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        }
    });
}

function endVoting() {
    fetch('/session/' + window.sessionId + '/end-voting', {
        method: 'POST'
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        }
    });
}

function nextTicket() {
    fetch('/session/' + window.sessionId + '/next-ticket', {
        method: 'POST'
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        }
    });
}

function showReviewModal() {
    const modal = document.getElementById('review-modal');
    if (modal) modal.classList.remove('hidden');
}

function hideReviewModal() {
    const modal = document.getElementById('review-modal');
    if (modal) modal.classList.add('hidden');
}

function startReview() {
    fetch('/session/' + window.sessionId + '/review', {
        method: 'POST'
    }).then(response => {
        if (response.ok) {
            window.location.href = '/session/' + window.sessionId + '/summary';
        }
    });
}

// Store the user's current vote for restoration after WebSocket updates
window.currentUserVote = null;

function castVote(voteValue) {
    console.log('Casting vote:', voteValue);
    
    // Store the vote for later restoration
    window.currentUserVote = voteValue;
    
    // Send vote to server - WebSocket will handle all other updates
    fetch('/session/' + window.sessionId + '/vote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'vote=' + encodeURIComponent(voteValue)
    }).then(response => {
        if (!response.ok) {
            console.error('Failed to cast vote');
            // Show error message 
            const voteStatus = document.getElementById('vote-status');
            if (voteStatus) {
                voteStatus.innerHTML = `
                    <div class="text-red-600 font-medium">
                        <span class="material-icons text-sm mr-1">error</span>
                        Failed to cast vote. Please try again.
                    </div>
                `;
            }
            // Revert card highlighting on error - find the card again
            const selectedCard = document.querySelector(`[data-value="${voteValue}"]`);
            if (selectedCard) {
                selectedCard.classList.remove('border-blue-500', 'bg-blue-50');
                selectedCard.classList.add('border-gray-300');
            }
        } else {
            console.log('Vote cast successfully:', voteValue);
            // WebSocket will handle the complete UI update
        }
    }).catch(error => {
        console.error('Error casting vote:', error);
        const voteStatus = document.getElementById('vote-status');
        if (voteStatus) {
            voteStatus.innerHTML = `
                <div class="text-red-600 font-medium">
                    <span class="material-icons text-sm mr-1">error</span>
                    Network error. Please check your connection.
                </div>
            `;
        }
        // Revert card highlighting on error - find the card again
        const selectedCard = document.querySelector(`[data-value="${voteValue}"]`);
        if (selectedCard) {
            selectedCard.classList.remove('border-blue-500', 'bg-blue-50');
            selectedCard.classList.add('border-gray-300');
        }
    });
}

// Function to restore participant vote display from template data
function updateParticipantVoteFromTemplate() {
    // Add delay to ensure DOM is stable after WebSocket update
    setTimeout(() => {
        try {
            // Use stored vote value if available
            if (window.currentUserVote) {
                console.log('Updating participant vote from stored value:', window.currentUserVote);
                updateParticipantVote(window.currentUserVote);
                return;
            }
            
            // Fallback: get vote from template if no stored value
            const voteStatusElement = document.getElementById('vote-status');
            if (!voteStatusElement) return;
            
            const voteStatusText = voteStatusElement.textContent;
            const voteMatch = voteStatusText.match(/Your vote: (.+)/);
            
            if (voteMatch) {
                const currentVote = voteMatch[1].trim();
                console.log('Updating participant vote from template:', currentVote);
                updateParticipantVote(currentVote);
            }
        } catch (error) {
            console.error('Error in updateParticipantVoteFromTemplate:', error);
        }
    }, 100);
}

// WebSocket is handled globally in base template

// Restore card highlighting after content refresh
function restoreCardHighlighting(voteValue) {
    try {
        console.log('Restoring card highlighting for vote:', voteValue);
        
        // Clear all card selections first
        const votingCards = document.querySelectorAll('.voting-card');
        if (votingCards.length === 0) {
            console.log('No voting cards found, DOM may not be ready yet');
            return;
        }
        
        votingCards.forEach(card => {
            if (card && card.classList) {
                card.classList.remove('border-blue-500', 'bg-blue-50');
                card.classList.add('border-gray-300');
            }
        });
        
        // Highlight the selected card
        const selectedCard = document.querySelector(`[data-value="${voteValue}"]`);
        if (selectedCard && selectedCard.classList) {
            selectedCard.classList.remove('border-gray-300');
            selectedCard.classList.add('border-blue-500', 'bg-blue-50');
            console.log('Card highlighting restored for:', voteValue);
        } else {
            console.log('Could not find card with value:', voteValue);
        }
    } catch (error) {
        console.error('Error in restoreCardHighlighting:', error);
    }
}

// Update participant vote display for current user
function updateParticipantVote(voteValue) {
    try {
        // Find the current user's participant card and update it
        const currentUserId = {{if .User}}'{{.User.ID}}'{{else}}null{{end}};
        if (!currentUserId) return;
        
        // Find all participant cards
        const participantCards = document.querySelectorAll('.grid.grid-cols-2 > div');
        if (participantCards.length === 0) {
            console.log('No participant cards found, DOM may not be ready yet');
            return;
        }
        
        participantCards.forEach(card => {
            if (!card) return;
            
            // Check if this card belongs to the current user
            const username = card.querySelector('.text-sm.font-medium');
            const currentUserName = '{{if .User}}{{.User.Username}}{{end}}';
            
            if (username && username.textContent && username.textContent.trim() === currentUserName) {
                // Find the vote display area in this card
                const voteDisplay = card.querySelector('.w-12.h-16');
                if (voteDisplay) {
                    // Check if voting is active to determine display style
                    const isVotingActive = {{.Session.IsVotingActive}};
                    
                    if (isVotingActive) {
                        // Show check mark for active voting
                        voteDisplay.className = 'w-12 h-16 bg-blue-600 rounded-lg flex items-center justify-center';
                        voteDisplay.innerHTML = '<span class="material-icons text-white">check</span>';
                    } else {
                        // Show vote value for inactive voting
                        voteDisplay.className = 'w-12 h-16 bg-green-100 border-2 border-green-300 rounded-lg flex items-center justify-center';
                        voteDisplay.innerHTML = `<span class="text-green-700 font-bold">${voteValue}</span>`;
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error in updateParticipantVote:', error);
    }
}

// Emoji Picker and Animation System
let emojiPickerTimer;
let currentTargetParticipant = null;

// Track shake intensity for each participant (user ID -> shake level)
let participantShakeIntensity = new Map();

function showEmojiPicker(participantElement, event) {
    // Don't show emoji picker for current user
    const currentUserId = {{if .User}}'{{.User.ID}}'{{else}}null{{end}};
    const targetId = participantElement.dataset.participantId;
    
    if (currentUserId === targetId) return;
    
    clearTimeout(emojiPickerTimer);
    currentTargetParticipant = participantElement;
    
    const picker = document.getElementById('emoji-picker');
    if (!picker) return;
    
    // Position picker near the participant
    const rect = participantElement.getBoundingClientRect();
    picker.style.left = (rect.right + 10) + 'px';
    picker.style.top = rect.top + 'px';
    picker.classList.remove('hidden');
    
    // Add click handlers to emoji options
    const emojiOptions = picker.querySelectorAll('.emoji-option');
    emojiOptions.forEach(option => {
        option.onclick = function() {
            sendEmojiReaction(this.dataset.emoji, targetId, participantElement.dataset.participantName);
            // Don't hide picker - allow spam clicking!
        };
    });
}

function hideEmojiPicker() {
    emojiPickerTimer = setTimeout(() => {
        const picker = document.getElementById('emoji-picker');
        if (picker) {
            picker.classList.add('hidden');
        }
        currentTargetParticipant = null;
    }, 100); // Small delay to allow clicking on emojis
}

function sendEmojiReaction(emoji, targetUserId, targetUsername) {
    console.log('Sending emoji reaction:', emoji, 'to', targetUsername);
    
    // Send emoji reaction via WebSocket (ws is global from base template)
    if (typeof ws !== 'undefined' && ws && ws.readyState === WebSocket.OPEN) {
        const message = {
            type: 'emoji-reaction',
            data: {
                emoji: emoji,
                target_user_id: targetUserId,
                target_username: targetUsername,
                from_user_id: {{if .User}}'{{.User.ID}}'{{else}}null{{end}},
                from_username: {{if .User}}'{{.User.Username}}'{{else}}null{{end}}
            }
        };
        console.log('Sending WebSocket message:', message);
        ws.send(JSON.stringify(message));
    } else {
        console.error('WebSocket not available or not connected');
    }
}

function showEmojiAnimation(emoji, targetUserId, fromUsername) {
    console.log('Showing emoji animation:', emoji, 'for user', targetUserId);
    
    // Find the target participant element
    const targetElement = document.querySelector(`[data-participant-id="${targetUserId}"]`);
    if (!targetElement) {
        console.log('Target element not found for user:', targetUserId);
        return;
    }
    
    // Create flying emoji element
    const flyingEmoji = document.createElement('div');
    flyingEmoji.innerHTML = emoji;
    flyingEmoji.className = 'emoji-reaction fixed pointer-events-none z-1000 text-4xl';
    
    // Start from random position at top of screen for more dramatic effect
    const startX = Math.random() * window.innerWidth;
    const startY = -50;
    
    flyingEmoji.style.left = startX + 'px';
    flyingEmoji.style.top = startY + 'px';
    flyingEmoji.style.transform = 'translate(-50%, -50%) rotate(0deg)';
    flyingEmoji.style.transition = 'none'; // Start without transition
    
    document.body.appendChild(flyingEmoji);
    
    // Get target position
    const targetRect = targetElement.getBoundingClientRect();
    const targetX = targetRect.left + (targetRect.width / 2);
    const targetY = targetRect.top + (targetRect.height / 2);
    
    // Phase 1: Fly to target with physics curve
    setTimeout(() => {
        flyingEmoji.style.transition = 'all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        flyingEmoji.style.left = targetX + 'px';
        flyingEmoji.style.top = targetY + 'px';
        flyingEmoji.style.transform = 'translate(-50%, -50%) rotate(360deg) scale(1.2)';
    }, 50);
    
    // Phase 2: Collision impact - bounce and shake with cumulative intensity
    setTimeout(() => {
        // Increase shake intensity for this participant
        const currentIntensity = participantShakeIntensity.get(targetUserId) || 0;
        const newIntensity = Math.min(currentIntensity + 1, 5); // Cap at 5 for sanity
        participantShakeIntensity.set(targetUserId, newIntensity);
        
        // Apply shake with increasing intensity
        const shakeClass = `shake-intensity-${newIntensity}`;
        targetElement.className = targetElement.className.replace(/shake-intensity-\d+/g, '');
        targetElement.classList.add(shakeClass);
        targetElement.style.animation = `${shakeClass} ${0.4 + newIntensity * 0.1}s ease-in-out`;
        
        // Emoji bounces back slightly
        flyingEmoji.style.transition = 'all 0.3s ease-out';
        flyingEmoji.style.transform = 'translate(-50%, -50%) rotate(360deg) scale(1.5)';
        
        // Gradually reduce shake intensity over time
        setTimeout(() => {
            const reduceIntensity = () => {
                const current = participantShakeIntensity.get(targetUserId) || 0;
                if (current > 0) {
                    const reduced = current - 1;
                    participantShakeIntensity.set(targetUserId, reduced);
                    
                    if (reduced > 0) {
                        const newShakeClass = `shake-intensity-${reduced}`;
                        targetElement.className = targetElement.className.replace(/shake-intensity-\d+/g, '');
                        targetElement.classList.add(newShakeClass);
                        targetElement.style.animation = `${newShakeClass} ${0.3 + reduced * 0.1}s ease-in-out`;
                        setTimeout(reduceIntensity, 600); // Reduce every 600ms
                    } else {
                        // Reset completely
                        targetElement.style.animation = '';
                        targetElement.className = targetElement.className.replace(/shake-intensity-\d+/g, '');
                    }
                }
            };
            reduceIntensity();
        }, 300);
    }, 1200);
    
    // Phase 3: Fall away with gravity physics
    setTimeout(() => {
        flyingEmoji.style.transition = 'all 1.0s cubic-bezier(0.55, 0.05, 0.68, 0.19)';
        flyingEmoji.style.left = (targetX + (Math.random() - 0.5) * 100) + 'px';
        flyingEmoji.style.top = (window.innerHeight + 100) + 'px'; // Fall off screen
        flyingEmoji.style.transform = 'translate(-50%, -50%) rotate(' + (Math.random() * 720 - 360) + 'deg) scale(0.3)';
        flyingEmoji.style.opacity = '0';
    }, 1500);
    
    // Show notification
    showEmojiNotification(emoji, fromUsername, targetElement.dataset.participantName);
    
    // Remove element after all animations
    setTimeout(() => {
        if (flyingEmoji.parentNode) {
            flyingEmoji.parentNode.removeChild(flyingEmoji);
        }
    }, 2600);
}

function showEmojiNotification(emoji, fromUsername, toUsername) {
    // Create temporary notification
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-3 z-50 animate-fade-in-up';
    notification.innerHTML = `
        <div class="flex items-center space-x-2">
            <span class="text-2xl">${emoji}</span>
            <span class="text-sm text-gray-600">
                <strong>${fromUsername}</strong> reacted to <strong>${toUsername}</strong>
            </span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove notification after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// Keep emoji picker open when hovering over it
document.addEventListener('DOMContentLoaded', function() {
    const picker = document.getElementById('emoji-picker');
    if (picker) {
        picker.onmouseenter = function() {
            clearTimeout(emojiPickerTimer);
        };
        picker.onmouseleave = hideEmojiPicker;
    }
});

// Test function for debugging emoji animations
window.testEmojiAnimation = function() {
    const participants = document.querySelectorAll('[data-participant-id]');
    if (participants.length > 0) {
        const target = participants[0];
        showEmojiAnimation('ðŸŽ‰', target.dataset.participantId, 'Test User');
    }
};

</script>
{{end}}
