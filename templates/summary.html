{{define "summary-content"}}
<div id="summary-content">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Session Review</h1>
            <h2 class="text-xl text-gray-600 mb-4">{{.Session.Name}}</h2>
            <div class="flex justify-center items-center space-x-4 text-sm text-gray-500">
                <span>
                    <span class="material-icons text-sm mr-1">group</span>
                    {{len .Session.Participants}} participants
                </span>
                <span>•</span>
                <span>
                    <span class="material-icons text-sm mr-1">assignment</span>
                    {{len .Session.Tickets}} tickets reviewed
                </span>
                <span>•</span>
                <span>
                    <span class="material-icons text-sm mr-1">schedule</span>
                    Session ended
                </span>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="grid lg:grid-cols-5 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-blue-600 mb-2">{{.TotalVotes}}</div>
                <div class="text-gray-600 text-sm">Total Votes</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-green-600 mb-2">{{.EstimatedTickets}}</div>
                <div class="text-gray-600 text-sm">Tickets Estimated</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                {{if .OverallStats.HasValues}}
                <div class="text-2xl font-bold text-purple-600 copyable-value mb-2" 
                     onclick="copyAverageValue(event, '{{printf "%.1f" .OverallStats.Median}}')"
                     title="Click to copy overall median">{{printf "%.1f" .OverallStats.Median}}</div>
                <div class="text-gray-600 text-sm">Overall Median</div>
                {{else}}
                <div class="text-2xl font-bold text-gray-400 mb-2">N/A</div>
                <div class="text-gray-600 text-sm">Overall Median</div>
                {{end}}
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                {{if .OverallStats.HasValues}}
                <div class="text-2xl font-bold text-blue-600 copyable-value mb-2" 
                     onclick="copyAverageValue(event, '{{printf "%.1f" .OverallStats.Mean}}')"
                     title="Click to copy overall mean">{{printf "%.1f" .OverallStats.Mean}}</div>
                <div class="text-gray-600 text-sm">Overall Mean</div>
                {{else}}
                <div class="text-2xl font-bold text-gray-400 mb-2">N/A</div>
                <div class="text-gray-600 text-sm">Overall Mean</div>
                {{end}}
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-xl font-bold text-green-600 copyable-value mb-2" 
                     onclick="copyAverageValue(event, '{{.OverallStats.Mode}}')"
                     title="Click to copy overall mode">{{.OverallStats.Mode}}</div>
                <div class="text-gray-600 text-sm">Overall Mode</div>
            </div>
        </div>

        <!-- Tickets Summary -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                <span class="material-icons text-blue-600 mr-2">list_alt</span>
                Ticket Estimates
            </h3>
            <div class="space-y-4">
                {{range .Session.Tickets}}
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="font-semibold text-lg">{{.Title}}</h4>
                            {{if .Description}}
                            <p class="text-gray-600 text-sm mt-1">{{.Description}}</p>
                            {{end}}
                        </div>
                        <div class="ml-4 text-right">
                            {{$ticketStats := index $.TicketStats .ID}}
                            {{if .FinalEstimate}}
                            <div class="text-2xl font-bold text-green-600">{{.FinalEstimate}}</div>
                            <div class="text-xs text-gray-500">Final Estimate</div>
                            {{else if $ticketStats}}
                            <div class="space-y-1">
                                {{if $ticketStats.HasValues}}
                                <div class="text-lg font-bold text-purple-600 copyable-value" 
                                     onclick="copyAverageValue(event, '{{printf "%.1f" $ticketStats.Median}}')"
                                     title="Click to copy median value">Median: {{printf "%.1f" $ticketStats.Median}}</div>
                                <div class="text-sm font-semibold text-blue-600 copyable-value" 
                                     onclick="copyAverageValue(event, '{{printf "%.1f" $ticketStats.Mean}}')"
                                     title="Click to copy mean value">Mean: {{printf "%.1f" $ticketStats.Mean}}</div>
                                {{end}}
                                <div class="text-sm font-semibold text-green-600 copyable-value" 
                                     onclick="copyAverageValue(event, '{{$ticketStats.Mode}}')"
                                     title="Click to copy mode value">Mode: {{$ticketStats.Mode}}</div>
                            </div>
                            {{else}}
                            <div class="text-gray-400">No votes</div>
                            {{end}}
                        </div>
                    </div>
                    
                    {{if .Votes}}
                    <!-- Vote breakdown for this ticket -->
                    <div class="border-t pt-3 mt-3">
                        <h5 class="text-sm font-medium text-gray-700 mb-2">Vote Breakdown:</h5>
                        
                        <!-- Calculate vote histogram for this ticket -->
                        {{$voteGroups := index $.TicketVoteGroups .ID}}
                        {{if $voteGroups}}
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                            {{range $voteGroups}}
                            <div class="bg-gray-50 rounded p-2 text-center">
                                <div class="font-bold text-blue-600">{{.Value}}</div>
                                <div class="text-xs text-gray-600">{{.Count}} vote{{if ne .Count 1}}s{{end}}</div>
                            </div>
                            {{end}}
                        </div>
                        {{end}}
                        
                        <!-- Individual votes -->
                        <div class="text-sm">
                            <span class="font-medium text-gray-700">Individual votes: </span>
                            {{range $index, $vote := .Votes}}
                                {{if $index}}, {{end}}
                                <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                                    {{if $vote.User}}{{$vote.User.Username}}{{else}}Unknown{{end}}: {{$vote.VoteValue}}
                                </span>
                            {{end}}
                        </div>
                        
                        <!-- Statistics for this ticket -->
                        {{$ticketStats := index $.TicketStats .ID}}
                        {{if $ticketStats}}
                        <div class="mt-3 p-2 bg-gray-50 rounded text-sm space-y-1">
                            <div class="font-medium text-gray-700 mb-2">Statistical Summary:</div>
                            {{if $ticketStats.HasValues}}
                            <div>
                                <span class="font-medium text-gray-600">Median: </span>
                                <span class="font-bold text-purple-600 copyable-value" 
                                      onclick="copyAverageValue(event, '{{printf "%.1f" $ticketStats.Median}}')"
                                      title="Click to copy median value">{{printf "%.1f" $ticketStats.Median}}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">Mean: </span>
                                <span class="font-bold text-blue-600 copyable-value" 
                                      onclick="copyAverageValue(event, '{{printf "%.1f" $ticketStats.Mean}}')"
                                      title="Click to copy mean value">{{printf "%.1f" $ticketStats.Mean}}</span>
                            </div>
                            {{end}}
                            <div>
                                <span class="font-medium text-gray-600">Mode: </span>
                                <span class="font-bold text-green-600 copyable-value" 
                                      onclick="copyAverageValue(event, '{{$ticketStats.Mode}}')"
                                      title="Click to copy mode value">{{$ticketStats.Mode}}</span>
                            </div>
                        </div>
                        {{end}}
                    </div>
                    {{else}}
                    <div class="border-t pt-3 mt-3 text-gray-500 text-sm">
                        No votes were cast for this ticket.
                    </div>
                    {{end}}
                </div>
                {{end}}
            </div>
        </div>

        <!-- Participants Summary -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                <span class="material-icons text-green-600 mr-2">group</span>
                Participant Contributions
            </h3>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                {{range .Session.Participants}}
                {{$participantStats := index $.ParticipantStats .ID}}
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-blue-600 font-medium text-sm">{{slice .Username 0 1}}</span>
                        </div>
                        <div>
                            <div class="font-medium">{{.Username}}</div>
                            {{if eq .ID $.Session.OwnerID}}
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Owner</span>
                            {{end}}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="text-center">
                            <div class="font-bold text-blue-600">{{if $participantStats}}{{$participantStats.VoteCount}}{{else}}0{{end}}</div>
                            <div class="text-gray-600 text-xs">Votes Cast</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-green-600">
                                {{if and $participantStats (gt $participantStats.VoteCount 0)}}
                                <span class="copyable-value" 
                                      onclick="copyAverageValue(event, '{{printf "%.1f" $participantStats.MedianVote}}')"
                                      title="Click to copy participant median">{{printf "%.1f" $participantStats.MedianVote}}</span>
                                {{else}}
                                -
                                {{end}}
                            </div>
                            <div class="text-gray-600 text-xs">Median Vote{{if and $participantStats (gt $participantStats.VoteCount 0)}} (click to copy){{end}}</div>
                        </div>
                    </div>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-lg shadow-md p-6 text-center">
            <div class="space-x-4">
                <a href="/" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 inline-flex items-center">
                    <span class="material-icons text-sm mr-2">home</span>
                    New Session
                </a>
                <button onclick="exportSummaryCSV()" class="bg-gray-600 text-white px-6 py-2 rounded hover:bg-gray-700 inline-flex items-center">
                    <span class="material-icons text-sm mr-2">download</span>
                    Export Summary
                </button>
            </div>
            <div class="mt-4 text-sm text-gray-500">
                This session has ended. The data will be preserved for your records.
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    .no-print {
        display: none !important;
    }
    
    body {
        font-size: 12px;
    }
    
    .bg-white {
        background-color: white !important;
        box-shadow: none !important;
    }
}

.copyable-value {
    cursor: pointer;
    transition: all 0.2s ease;
}

.copyable-value:hover {
    opacity: 0.8;
    transform: scale(1.05);
}
</style>

<script>
function copyAverageValue(event, value) {
    navigator.clipboard.writeText(value).then(function() {
        // Show a brief success message
        const element = event.target;
        const originalText = element.innerHTML;
        const originalColor = element.className;
        
        // Change to show copied state
        element.innerHTML = 'Copied!';
        element.className = originalColor.replace('text-purple-600', 'text-green-600');
        
        setTimeout(function() {
            element.innerHTML = originalText;
            element.className = originalColor;
        }, 1500);
    }).catch(function(err) {
        console.error('Failed to copy value: ', err);
        alert('Failed to copy value. Value: ' + value);
    });
}

function exportSummaryCSV() {
    const sessionId = '{{.Session.ID}}';
    // Simply redirect to the CSV export endpoint
    window.open(`/session/${sessionId}/export-csv`, '_blank');
}
</script>
{{end}}