<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Sprint Planning Poker</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" media="print" onload="this.media='all'; this.onload=null;">
    <link href="/static/css/app.css" rel="stylesheet">
    <style>
        .card {
            transition: all 0.2s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .card.selected {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4);
        }
        .emoji-reaction {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            font-size: 24px;
        }
        
        /* High z-index for emoji picker */
        .z-1000 {
            z-index: 1000;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }
        
        /* Cumulative shake intensity animations */
        .shake-intensity-1 {
            animation: shake-1 0.6s ease-in-out;
        }
        .shake-intensity-2 {
            animation: shake-2 0.7s ease-in-out;
        }
        .shake-intensity-3 {
            animation: shake-3 0.8s ease-in-out;
        }
        .shake-intensity-4 {
            animation: shake-4 0.9s ease-in-out;
        }
        .shake-intensity-5 {
            animation: shake-5 1.0s ease-in-out;
        }
        
        @keyframes shake-1 {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px) rotate(-1deg); }
            20%, 40%, 60%, 80% { transform: translateX(2px) rotate(1deg); }
        }
        
        @keyframes shake-2 {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px) rotate(-2deg); }
            20%, 40%, 60%, 80% { transform: translateX(4px) rotate(2deg); }
        }
        
        @keyframes shake-3 {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-6px) rotate(-3deg); }
            20%, 40%, 60%, 80% { transform: translateX(6px) rotate(3deg); }
        }
        
        @keyframes shake-4 {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px) rotate(-4deg); }
            20%, 40%, 60%, 80% { transform: translateX(8px) rotate(4deg); }
        }
        
        @keyframes shake-5 {
            0%, 100% { transform: translateX(0) rotate(0deg) scale(1); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px) rotate(-5deg) scale(1.05); }
            20%, 40%, 60%, 80% { transform: translateX(10px) rotate(5deg) scale(1.05); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-2xl font-bold text-blue-600 hover:text-blue-700 transition-colors">Sprint Planning Poker</a>
                    {{if .SessionName}}
                    <span class="text-gray-600">â€¢</span>
                    <span class="text-lg font-medium text-gray-800">{{.SessionName}}</span>
                    {{end}}
                </div>
                {{if .User}}
                <div class="flex items-center space-x-4">
                    {{if .Session}}
                    <!-- Session Navigation -->
                    <button 
                        onclick="copySessionUrl(event)" 
                        class="flex items-center space-x-1 px-3 py-1 text-sm text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-md transition-colors"
                        title="Copy session URL to share"
                    >
                        <span class="material-icons text-sm">share</span>
                        <span>Share</span>
                    </button>
                    {{if eq .User.ID .Session.OwnerID}}
                    <button 
                        onclick="showEndSessionModal()" 
                        class="flex items-center space-x-1 px-3 py-1 text-sm text-red-600 hover:text-red-700 hover:bg-red-50 rounded-md transition-colors"
                        title="End session for everyone"
                    >
                        <span class="material-icons text-sm">stop</span>
                        <span>End Session</span>
                    </button>
                    {{else}}
                    <button 
                        onclick="showLeaveSessionModal()" 
                        class="flex items-center space-x-1 px-3 py-1 text-sm text-gray-600 hover:text-gray-700 hover:bg-gray-50 rounded-md transition-colors"
                        title="Leave session"
                    >
                        <span class="material-icons text-sm">exit_to_app</span>
                        <span>Leave</span>
                    </button>
                    {{end}}
                    <span class="text-gray-300">|</span>
                    {{end}}
                    <span class="text-sm text-gray-600">Welcome, 
                        <button 
                            onclick="showEditUsernameModal()" 
                            class="text-blue-600 hover:text-blue-700 hover:underline font-medium"
                            title="Click to change your nickname"
                        >{{.User.Username}}</button>
                    </span>
                </div>
                {{end}}
            </div>
        </div>
    </header>

    <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {{if eq .Template "home"}}{{template "home-content" .}}{{end}}
        {{if eq .Template "session"}}{{template "session-content" .}}{{end}}
        {{if eq .Template "summary"}}{{template "summary-content" .}}{{end}}
    </main>

    <!-- Session Modals (for session and summary pages) -->
    {{if or (eq .Template "session") (eq .Template "summary")}}{{template "session-modals" .}}{{end}}

    <script src="/static/js/app.js"></script>
    <script>
    function copySessionUrl(event) {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(function() {
            // Show a brief success message
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="material-icons text-sm">check</span><span>Copied!</span>';
            setTimeout(function() {
                button.innerHTML = originalText;
            }, 2000);
        }).catch(function(err) {
            console.error('Failed to copy URL: ', err);
            alert('Failed to copy URL. Please copy manually: ' + url);
        });
    }

    // Check if we're on summary page for different modal behavior
    function isSummaryPage() {
        return window.location.pathname.includes('/summary');
    }

    function showEndSessionModal() {
        const modal = document.getElementById('end-session-modal');
        if (modal) {
            // Update modal text for summary page
            if (isSummaryPage()) {
                const messageElement = modal.querySelector('p');
                if (messageElement) {
                    messageElement.textContent = 'This will permanently delete the session data and redirect all users to the home page.';
                }
            }
            modal.classList.remove('hidden');
        }
    }

    function showLeaveSessionModal() {
        const modal = document.getElementById('leave-session-modal');
        if (modal) {
            // Update modal text for summary page
            if (isSummaryPage()) {
                const messageElement = modal.querySelector('p');
                if (messageElement) {
                    messageElement.textContent = 'You will be redirected to the home page.';
                }
            }
            modal.classList.remove('hidden');
        }
    }

    function hideEndSessionModal() {
        const modal = document.getElementById('end-session-modal');
        if (modal) modal.classList.add('hidden');
    }

    function hideLeaveSessionModal() {
        const modal = document.getElementById('leave-session-modal');
        if (modal) modal.classList.add('hidden');
    }

    // WebSocket connection for session pages
    let ws = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    
    // Get current user ID from page data
    const currentUserId = {{if .User}}'{{.User.ID}}'{{else}}null{{end}};

    function connectWebSocket() {
        // Only connect if we're on a session page
        const sessionMatch = window.location.pathname.match(/^\/session\/([^\/]+)$/);
        if (!sessionMatch) return;
        
        const sessionId = sessionMatch[1];
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/session/${sessionId}/ws`;
        
        // Close existing connection if any
        if (ws && ws.readyState !== WebSocket.CLOSED) {
            ws.close();
        }
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function(event) {
            console.log('WebSocket connection opened');
            reconnectAttempts = 0;
        };
        
        ws.onmessage = function(event) {
            try {
                const message = JSON.parse(event.data);
                console.log('WebSocket message received:', message.type, message.data);
                
                switch(message.type) {
                    case 'user-joined':
                    case 'user-left':
                    case 'voting-started':
                    case 'voting-ended':
                        // Always refresh when voting ends to show results
                        console.log('Voting ended - refreshing for all users');
                        htmx.ajax('GET', `/session/${sessionId}/partial`, {
                            target: '#session-content',
                            swap: 'outerHTML'
                        }).then(function() {
                            // Restore current user's participant vote display after refresh
                            if (typeof updateParticipantVoteFromTemplate === 'function') {
                                setTimeout(updateParticipantVoteFromTemplate, 50);
                            }
                        });
                        break;
                    case 'vote-cast':
                        // Always refresh to update participant votes and averages
                        console.log('Vote cast by user:', message.data.user_id, 'Current user:', currentUserId);
                        const isOwnVote = message.data.user_id === currentUserId;
                        
                        htmx.ajax('GET', `/session/${sessionId}/partial`, {
                            target: '#session-content',
                            swap: 'outerHTML'
                        }).then(function() {
                            if (isOwnVote) {
                                // Template should automatically show correct highlighting
                                // No need for JavaScript restoration
                                console.log('Template will handle card highlighting automatically');
                            }
                            
                            // Always restore participant vote display after refresh
                            if (typeof updateParticipantVoteFromTemplate === 'function') {
                                setTimeout(updateParticipantVoteFromTemplate, 150);
                            }
                        });
                        break;
                    case 'ticket-changed':
                    case 'ticket-created':
                    case 'ticket-deleted':
                    case 'ticket-updated':
                        // Use HTMX to refresh just the session content
                        console.log('Refreshing content for:', message.type);
                        htmx.ajax('GET', `/session/${sessionId}/partial`, {
                            target: '#session-content',
                            swap: 'outerHTML'
                        }).then(function() {
                            // Restore current user's participant vote display after refresh
                            if (typeof updateParticipantVoteFromTemplate === 'function') {
                                setTimeout(updateParticipantVoteFromTemplate, 50);
                            }
                        });
                        break;
                    case 'session-ended':
                        const sessionEndData = message.data;
                        if (sessionEndData && sessionEndData.redirect) {
                            // Review mode - redirect to summary
                            window.location.href = sessionEndData.redirect;
                        } else {
                            // Normal end - redirect to home
                            alert('This session has been ended by the owner.');
                            window.location.href = '/';
                        }
                        break;
                    case 'connected':
                        console.log('WebSocket connection confirmed');
                        break;
                    case 'emoji-reaction':
                        if (typeof showEmojiAnimation === 'function') {
                            showEmojiAnimation(
                                message.data.emoji,
                                message.data.target_user_id,
                                message.data.from_username
                            );
                        }
                        break;
                    default:
                        console.log('Unknown WebSocket message type:', message.type);
                }
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        };
        
        ws.onclose = function(event) {
            console.log('WebSocket connection closed:', event.code, event.reason);
            
            // Only attempt to reconnect if we're still on a session page
            const stillOnSession = window.location.pathname.match(/^\/session\/([^\/]+)$/);
            if (stillOnSession && reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.pow(2, reconnectAttempts) * 1000;
                console.log(`Attempting to reconnect in ${delay}ms (attempt ${reconnectAttempts})`);
                setTimeout(connectWebSocket, delay);
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    }

    // Connect WebSocket when page loads
    document.addEventListener('DOMContentLoaded', connectWebSocket);

    // Reconnect WebSocket when page becomes visible again
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && (!ws || ws.readyState === WebSocket.CLOSED)) {
            connectWebSocket();
        }
    });

    // Clean up WebSocket when leaving the page
    window.addEventListener('beforeunload', function() {
        if (ws) {
            ws.close();
        }
    });
    </script>
    
    <!-- Buy me a coffee footer -->
    <footer class="fixed bottom-4 right-4 z-10">
        <a href="https://venmo.com/code?user_id=cougargriff" 
           target="_blank" 
           rel="noopener noreferrer"
           class="flex items-center space-x-1 bg-white/80 backdrop-blur-sm border border-gray-200 rounded-lg px-3 py-2 text-xs text-gray-600 hover:text-gray-800 hover:bg-white/90 transition-all duration-200 shadow-sm hover:shadow-md"
           title="Support this project â˜•">
            <span>â˜•</span>
            <span>Buy me a coffee</span>
        </a>
    </footer>
</body>
</html>
