{{define "home-content"}}
{{if not .User}}
<!-- Username Modal -->
<div id="username-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        <h2 class="text-xl font-bold mb-4">Welcome to Sprint Planning Poker</h2>
        <p class="text-gray-600 mb-6">Please enter your display name to get started:</p>
        
        <form hx-post="/set-username" hx-target="#username-modal" hx-swap="outerHTML">
            <input type="hidden" name="redirect_to" id="redirect-to-field">
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                <input 
                    type="text" 
                    id="username" 
                    name="username" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="Enter your name"
                    required
                    maxlength="50"
                />
            </div>
            <button 
                type="submit" 
                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
                Continue
            </button>
        </form>
    </div>
</div>
{{else}}
<!-- Main Content -->
<div class="max-w-4xl mx-auto">
    <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-4">Sprint Planning Poker</h2>
        <p class="text-lg text-gray-600">Create a new session or join an existing one to start estimating.</p>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
        <!-- Create Session -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center mb-4">
                <span class="material-icons text-blue-600 mr-2">add_circle</span>
                <h3 class="text-xl font-semibold">Create New Session</h3>
            </div>
            
            <form hx-post="/session/create">
                <div class="mb-4">
                    <label for="session-name" class="block text-sm font-medium text-gray-700 mb-2">Session Name</label>
                    <input 
                        type="text" 
                        id="session-name" 
                        name="name" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        placeholder="e.g., Sprint 24 Planning"
                        required
                        maxlength="100"
                    />
                </div>
                <button 
                    type="submit" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    Create Session
                </button>
            </form>
        </div>

        <!-- Join Session -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center mb-4">
                <span class="material-icons text-green-600 mr-2">group_add</span>
                <h3 class="text-xl font-semibold">Join Existing Session</h3>
            </div>
            
            <form>
                <div class="mb-4">
                    <label for="session-url" class="block text-sm font-medium text-gray-700 mb-2">Session URL or ID</label>
                    <input 
                        type="text" 
                        id="session-url" 
                        name="sessionUrl" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                        placeholder="Paste session URL or enter session ID"
                    />
                </div>
                <button 
                    type="button" 
                    onclick="joinSessionFromUrl()"
                    class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                >
                    Join Session
                </button>
            </form>
        </div>
    </div>

    <!-- Tips -->
    <div class="mt-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Tips</h3>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <ul class="text-sm text-blue-800 space-y-2">
                <li class="flex items-start">
                    <span class="material-icons text-blue-600 text-sm mr-2 mt-0.5">info</span>
                    Sessions are automatically cleaned up after 6 hours of inactivity
                </li>
                <li class="flex items-start">
                    <span class="material-icons text-blue-600 text-sm mr-2 mt-0.5">people</span>
                    Share the session URL with your team to invite them
                </li>
                <li class="flex items-start">
                    <span class="material-icons text-blue-600 text-sm mr-2 mt-0.5">casino</span>
                    Use Fibonacci numbers (0, 1, 2, 3, 5, 8, 13, 21, 34) or special cards (â˜•, ?) for estimation
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- Edit Username Modal -->
<div id="edit-username-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        <h3 class="text-xl font-bold mb-4">Change Nickname</h3>
        <form hx-post="/set-username" hx-on::after-request="if(event.detail.successful) { hideEditUsernameModal(); window.location.reload(); }" novalidate hx-on::before-request="if(!validateUsernameForm()) event.preventDefault()">
            <div class="mb-6">
                <label for="new-username" class="block text-sm font-medium text-gray-700 mb-2">New Nickname</label>
                <input 
                    type="text" 
                    id="new-username" 
                    name="username" 
                    value="{{.User.Username}}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="Enter your new nickname"
                    maxlength="50"
                />
            </div>
            <div class="flex space-x-3">
                <button 
                    type="button" 
                    onclick="hideEditUsernameModal()"
                    class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400"
                >
                    Cancel
                </button>
                <button 
                    type="submit" 
                    class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
                >
                    Update Nickname
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function joinSessionFromUrl() {
    const input = document.getElementById('session-url');
    const value = input.value.trim();
    
    if (!value) {
        alert('Please enter a session URL or ID');
        return;
    }
    
    let sessionId = value;
    
    // Extract session ID from URL if full URL is provided
    if (value.includes('/session/')) {
        const urlParts = value.split('/session/');
        if (urlParts.length > 1) {
            sessionId = urlParts[1].split(/[/?]/)[0];
        }
    }
    
    if (sessionId) {
        window.location.href = `/session/${sessionId}`;
    } else {
        alert('Invalid session URL or ID');
    }
}

function showEditUsernameModal() {
    document.getElementById('edit-username-modal').classList.remove('hidden');
    document.getElementById('new-username').select();
}

function hideEditUsernameModal() {
    document.getElementById('edit-username-modal').classList.add('hidden');
    clearUsernameValidationErrors();
}

function clearUsernameValidationErrors() {
    const usernameInput = document.getElementById('new-username');
    usernameInput.classList.remove('border-red-500');
    const existingError = document.getElementById('username-error');
    if (existingError) {
        existingError.remove();
    }
}

function validateUsernameForm() {
    const username = document.getElementById('new-username').value.trim();
    const usernameInput = document.getElementById('new-username');
    
    clearUsernameValidationErrors();
    
    if (!username) {
        usernameInput.classList.add('border-red-500');
        const errorDiv = document.createElement('div');
        errorDiv.id = 'username-error';
        errorDiv.className = 'text-red-500 text-sm mt-1';
        errorDiv.textContent = 'Username is required';
        usernameInput.parentNode.appendChild(errorDiv);
        usernameInput.focus();
        return false;
    }
    
    if (username.length > 50) {
        usernameInput.classList.add('border-red-500');
        const errorDiv = document.createElement('div');
        errorDiv.id = 'username-error';
        errorDiv.className = 'text-red-500 text-sm mt-1';
        errorDiv.textContent = 'Username must be no more than 50 characters';
        usernameInput.parentNode.appendChild(errorDiv);
        usernameInput.focus();
        return false;
    }
    
    if (!/^[a-zA-Z0-9\s\-_]+$/.test(username)) {
        usernameInput.classList.add('border-red-500');
        const errorDiv = document.createElement('div');
        errorDiv.id = 'username-error';
        errorDiv.className = 'text-red-500 text-sm mt-1';
        errorDiv.textContent = 'Username can only contain letters, numbers, spaces, hyphens, and underscores';
        usernameInput.parentNode.appendChild(errorDiv);
        usernameInput.focus();
        return false;
    }
    
    return true;
}

// Set redirect_to field if we came from a session URL
document.addEventListener('DOMContentLoaded', function() {
    const redirectField = document.getElementById('redirect-to-field');
    if (redirectField) {
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect_to') || window.location.pathname;
        if (redirect && redirect !== '/' && redirect !== '/home') {
            redirectField.value = redirect;
        }
    }
    
    // If user already has a username and there's a redirect_to parameter, redirect automatically
    const hasUser = {{if .User}}true{{else}}false{{end}};
    if (hasUser) {
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect_to');
        if (redirect && redirect !== '/' && redirect !== '/home') {
            console.log('Redirecting user to:', redirect);
            window.location.href = redirect;
        }
    }
});
</script>
{{end}}
{{end}}